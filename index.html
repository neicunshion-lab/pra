<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONE OK ROCK ãƒ•ã‚¡ãƒ³æ²ç¤ºæ¿</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ç”¨ã®CSSå¤‰æ•°ã‚’å®šç¾©ï¼ˆJavaScriptã§å‹•çš„ã«ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰ */
        :root {
            --color-primary: #FF5050; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: Ambitions */
            --color-secondary: #1A2035;
            --color-background: #f7f7f7;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background); /* ãƒ†ãƒ¼ãƒèƒŒæ™¯è‰²ã‚’é©ç”¨ */
            transition: background-color 0.5s ease;
        }
        
        .scrollable-content {
            max-height: 70vh; /* ç”»é¢ã®é«˜ã•ã«å¿œã˜ã¦èª¿æ•´ */
            overflow-y: auto;
        }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆä»»æ„ï¼‰ */
        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-content::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 4px;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ©ãƒ¼ã‚’ä½¿ã£ãŸTailwindã®ã‚¯ãƒ©ã‚¹ã‚’æ˜ç¤ºçš„ã«å®šç¾©ï¼ˆCDNä½¿ç”¨ã®ãŸã‚ä»»æ„ã®å€¤ã‚’ä½¿ç”¨ï¼‰ */
        .text-primary { color: var(--color-primary); }
        .bg-primary { background-color: var(--color-primary); }
        .hover\:bg-secondary:hover { background-color: var(--color-secondary); }
        .focus\:ring-primary:focus { --tw-ring-color: var(--color-primary); }
        .focus\:border-primary:focus { border-color: var(--color-primary); }

        /* ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆå°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .chat-container {
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¸‹ã«æ¥ã‚‹ã‚ˆã†ã« */
        }
        .message-bubble {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 8px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .user-message {
            align-self: flex-end;
            background-color: var(--color-primary);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .ai-message {
            align-self: flex-start;
            background-color: #E5E7EB;
            color: #1F2937;
            border-bottom-left-radius: 4px;
        }
        /* ã‚¯ã‚¤ã‚ºé¸æŠè‚¢ã®ãƒ›ãƒãƒ¼åŠ¹æœ */
        .quiz-option:hover:not(:disabled) {
            background-color: var(--color-primary);
            color: white;
            opacity: 0.9;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="message-area" class="fixed top-4 right-4 z-50"></div>

    <!-- åˆ©ç”¨è¦ç´„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="terms-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">åˆ©ç”¨è¦ç´„</h2>
            <div class="scrollable-content mb-6 p-2 border rounded-lg bg-gray-50">
                <p class="text-sm text-gray-600 space-y-2">
                    <strong>ç¬¬1æ¡ (ç›®çš„)</strong>
                    <br>æœ¬æ²ç¤ºæ¿ã¯ã€ONE OK ROCKã®ãƒ•ã‚¡ãƒ³åŒå£«ãŒäº¤æµã—ã€æƒ…å ±äº¤æ›ã‚’è¡Œã†ãŸã‚ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§ã™ã€‚
                    <br><br><strong>ç¬¬2æ¡ (ç¦æ­¢äº‹é …)</strong>
                    <br>ä»¥ä¸‹ã®è¡Œç‚ºã‚’å³ç¦ã—ã¾ã™ã€‚
                    <ul class="list-disc list-inside ml-4 mt-2">
                        <li>ä»–è€…ã¸ã®èª¹è¬—ä¸­å‚·ã€å·®åˆ¥çš„ãªç™ºè¨€ã€ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆè¡Œç‚ºã€‚</li>
                        <li>è‘—ä½œæ¨©ã€è‚–åƒæ¨©ãªã©ã®çŸ¥çš„è²¡ç”£æ¨©ã‚’ä¾µå®³ã™ã‚‹æŠ•ç¨¿ã€‚</li>
                        <li>å…¬åºè‰¯ä¿—ã«åã™ã‚‹å†…å®¹ã€ã¾ãŸã¯é•æ³•è¡Œç‚ºã‚’åŠ©é•·ã™ã‚‹å†…å®¹ã®æŠ•ç¨¿ã€‚</li>
                        <li>å•†æ¥­ç›®çš„ã®å®£ä¼ã€å‹§èª˜è¡Œç‚ºã€‚</li>
                        <li>å€‹äººæƒ…å ±ã®ç„¡æ–­å…¬é–‹ã€‚</li>
                    </ul>
                    <br><strong>ç¬¬3æ¡ (å…è²¬äº‹é …)</strong>
                    <br>æŠ•ç¨¿å†…å®¹ã¯æŠ•ç¨¿è€…å€‹äººã®æ„è¦‹ã§ã‚ã‚Šã€æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã®ç®¡ç†è€…åŠã³é–‹ç™ºè€…ã¯ãã®å†…å®¹ã«ã¤ã„ã¦ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚
                    <br><br><strong>ç¬¬4æ¡ (ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ID)</strong>
                    <br>æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã€åŒ¿åã¾ãŸã¯ä¸€æ™‚çš„ãªèªè¨¼ã«åŸºã¥ããƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¬é–‹ã•ã‚Œã¾ã™ã€‚
                    <br><br><strong>ç¬¬5æ¡ (æŠ•ç¨¿ã®å‰Šé™¤)</strong>
                    <br>ç®¡ç†è€…ã¯ã€æœ¬è¦ç´„ã«é•åã™ã‚‹æŠ•ç¨¿ã€ã¾ãŸã¯ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®ç§©åºã‚’ä¹±ã™ã¨åˆ¤æ–­ã—ãŸæŠ•ç¨¿ã‚’ã€äºˆå‘Šãªãå‰Šé™¤ã™ã‚‹æ¨©åˆ©ã‚’æœ‰ã—ã¾ã™ã€‚
                </p>
            </div>
            <!-- ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é©ç”¨ -->
            <button onclick="agreeToTerms()" class="w-full bg-primary hover:bg-secondary text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md hover:shadow-lg">
                è¦ç´„ã«åŒæ„ã—ã¦æ²ç¤ºæ¿ã‚’é–‹ã
            </button>
        </div>
    </div>

    <!-- æŠ•ç¨¿ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">æŠ•ç¨¿ã‚’ç·¨é›†</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-post-id">
                <input type="text" id="edit-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" required maxlength="100">
                <textarea id="edit-content" rows="6" placeholder="å†…å®¹" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary resize-none" required maxlength="2000"></textarea>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideEditModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition duration-150">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <!-- ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é©ç”¨ -->
                    <button type="submit" class="px-4 py-2 bg-primary hover:bg-secondary text-white rounded-lg transition duration-150">
                        ä¿å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">æŠ•ç¨¿ã®å‰Šé™¤ç¢ºèª</h2>
            <p class="text-gray-600 mb-6">æœ¬å½“ã«ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿä¸€åº¦å‰Šé™¤ã™ã‚‹ã¨å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="hideDeleteConfirmModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition duration-150">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" id="confirm-delete-button" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition duration-150">
                    å‰Šé™¤ã™ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="nickname-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’è¨­å®š</h2>
            <form id="nickname-form">
                <input type="text" id="nickname-input" placeholder="3æ–‡å­—ä»¥ä¸Š15æ–‡å­—ä»¥ä¸‹ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" required minlength="3" maxlength="15">
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideNicknameModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition duration-150">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="px-4 py-2 bg-primary hover:bg-secondary text-white rounded-lg transition duration-150">
                        è¨­å®šã‚’ä¿å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆåŒæ„å¾Œã«è¡¨ç¤ºï¼‰ -->
    <main id="main-content" class="hidden max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <!-- ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é©ç”¨ -->
            <h1 class="text-4xl font-extrabold text-primary tracking-wider">ONE OK ROCK ğŸ¸ FAN BOARD</h1>
            <p class="text-gray-600 mt-1">ã‚ãªãŸã®OOReræ„›ã‚’è‡ªç”±ã«èªã‚Šã¾ã—ã‚‡ã†ï¼</p>
            
            <div id="user-info-area" class="text-xs text-gray-500 mt-2 p-1 bg-gray-100 rounded-lg inline-block flex items-center justify-center space-x-2">
                <span id="user-info">ID: (èª­ã¿è¾¼ã¿ä¸­)</span>
                <button onclick="showNicknameModal()" class="text-blue-500 hover:text-blue-700 font-medium py-1 px-2 rounded-lg transition duration-150 border border-blue-200">
                    ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¨­å®š
                </button>
            </div>
            
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿çµã‚Šè¾¼ã¿è§£é™¤ãƒœã‚¿ãƒ³ -->
            <button id="clear-user-filter-button" onclick="clearUserFilter()" class="hidden text-sm mt-3 px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition duration-150 font-bold">
                ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿ä¸€è¦§ã‚’è§£é™¤
            </button>
        </header>

        <!-- ãƒ©ã‚¤ãƒ–æƒ…å ±è¡¨ç¤ºæ¬„ -->
        <section class="mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">æœ€æ–°ãƒ©ã‚¤ãƒ–æƒ…å ± (å…¬å¼ã‚µã‚¤ãƒˆ)</h2>
            <div id="live-info-container" class="bg-white p-6 rounded-xl shadow-lg">
                <p class="text-center text-gray-500">å…¬å¼ã‚µã‚¤ãƒˆã¸ã®ãƒªãƒ³ã‚¯ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </section>
        
        <!-- AIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ & ã‚¯ã‚¤ã‚ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">ğŸ¤ OOR AIãƒãƒ£ãƒƒãƒˆ & ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ã‚¤ã‚º (2-4äºº)</h2>
            
            <!-- ã‚¯ã‚¤ã‚ºã‚¨ãƒªã‚¢ -->
            <div id="quiz-area" class="mb-6 border border-gray-300 rounded-lg p-4 bg-gray-50">
                <h3 class="text-lg font-bold mb-3 text-primary">ONE OK ROCK ã‚¯ã‚¤ã‚ºå¤§ä¼šï¼</h3>
                
                <!-- ãƒ«ãƒ¼ãƒ IDç®¡ç†UI -->
                <div class="mb-4 p-3 bg-white rounded-lg border flex flex-col sm:flex-row items-stretch sm:items-center space-y-2 sm:space-y-0 sm:space-x-2">
                    <label for="room-id-input" class="text-sm font-semibold text-gray-700 whitespace-nowrap flex-shrink-0">ãƒ«ãƒ¼ãƒ ID:</label>
                    <input type="text" id="room-id-input" value="one_ok_rock_quiz" placeholder="æ–°ã—ã„ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-primary focus:border-primary" maxlength="20">
                    <button onclick="changeQuizRoom()" class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-2 px-4 rounded-lg flex-shrink-0 transition duration-150">
                        åˆ‡æ›¿/ä½œæˆ
                    </button>
                </div>
                <p class="text-xs text-gray-500 mb-2">ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ : <strong id="current-room-display" class="text-gray-700">one_ok_rock_quiz</strong></p>
                
                <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ­ãƒƒãƒˆ -->
                <p class="text-sm font-semibold mb-2 text-gray-700">å‚åŠ è€… (<span id="player-count">0</span>/4):</p>
                <div id="player-slots" class="flex flex-wrap gap-3 mb-4 p-2 bg-white rounded-lg border">
                    <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ­ãƒƒãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>

                <div id="quiz-status-message" class="text-center text-gray-600 mb-4 font-medium">
                    ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã™ã‚‹ã«ã¯2äººä»¥ä¸Šã®å‚åŠ ãŒå¿…è¦ã§ã™ã€‚ï¼ˆæœ€å¤§4äººï¼‰
                </div>

                <div id="quiz-question-container" class="hidden">
                    <p class="text-sm font-semibold mb-2 text-gray-700">ç¾åœ¨ã®å•é¡Œ:</p>
                    <div id="current-question" class="text-xl font-bold mb-4 p-3 bg-white border rounded-lg"></div>
                    <div id="quiz-options" class="space-y-2">
                        <!-- é¸æŠè‚¢ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                </div>
                
                <!-- ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ -->
                <div id="quiz-scoreboard" class="mt-6 pt-4 border-t border-gray-200">
                    <p class="text-sm font-semibold mb-2 text-gray-700">ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰:</p>
                    <div id="scoreboard-list" class="flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-600">
                        <!-- å‚åŠ è€…ã‚¹ã‚³ã‚¢ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        <p class="text-xs text-gray-400">ã‚¯ã‚¤ã‚ºé–‹å§‹å¾Œã«ã‚¹ã‚³ã‚¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                    </div>
                </div>

                <div id="quiz-controls" class="mt-6 flex justify-center">
                    <button onclick="startNewQuiz()" id="start-quiz-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-150 shadow-md" disabled>
                        ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ (2äººã‹ã‚‰)
                    </button>
                    <button onclick="requestNextQuestion()" id="next-question-button" class="hidden bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition duration-150 shadow-md">
                        æ¬¡ã®å•é¡Œã¸
                    </button>
                </div>

                <div id="quiz-loading-message" class="hidden mt-3 text-center text-sm text-primary font-medium">
                    AIãŒå•é¡Œã‚’ä½œæˆä¸­...ğŸ¸ ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚
                </div>
            </div>

            <!-- AIãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
            <p class="text-sm text-gray-600 mb-4 border-t pt-4">ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã«è³ªå•ã™ã‚‹:</p>
            
            <div class="chat-container mb-4 border border-gray-300 rounded-lg p-3 bg-gray-50 flex flex-col-reverse" id="ai-chat-history">
                <!-- Chat messages will be appended here -->
                <div class="ai-message text-xs font-medium self-start">
                    ã“ã‚“ã«ã¡ã¯ï¼ONE OK ROCKã®ã“ã¨ã¯ä½•ã§ã‚‚èã„ã¦ãã ã•ã„ã­ã€‚æº–å‚™ã¯ã„ã„ã§ã™ã‹ï¼Ÿ
                </div>
            </div>

            <form id="ai-chat-form" class="flex">
                <input type="text" id="ai-chat-input" placeholder="ä¾‹: Takaã®ãŠæ°—ã«å…¥ã‚Šã®æ›²ã¯ï¼Ÿ" class="w-full p-3 border border-gray-300 rounded-l-lg text-sm focus:ring-primary focus:border-primary" required>
                <!-- ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é©ç”¨ -->
                <button type="submit" id="ai-chat-button" class="bg-primary hover:bg-secondary text-white font-bold py-3 px-6 rounded-r-lg transition duration-150 shadow-md flex-shrink-0">
                    è³ªå•
                </button>
            </form>
            <div id="ai-loading-message" class="hidden mt-2 text-sm text-primary font-medium">
                AIãŒå›ç­”ã‚’è€ƒãˆä¸­ã§ã™...ğŸ¸
            </div>
            
            <!-- AIåˆ©ç”¨æ¡ä»¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="ai-usage-condition" class="mt-4 text-center text-sm text-gray-600">
                AIæ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€æ²ç¤ºæ¿ã«**3å›ä»¥ä¸Š**æŠ•ç¨¿ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ç¾åœ¨ã®æŠ•ç¨¿æ•°: <span id="user-post-count" class="font-bold text-primary">0</span>å›
            </div>
        </section>

        <!-- æ–°è¦æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
        <section class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">æ–°è¦æŠ•ç¨¿</h2>
            <form id="post-form">
                <!-- ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›æ¬„ -->
                <input type="text" id="post-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: å¥½ããªæ›²ã¯ï¼Ÿ)" class="w-full p-3 mb-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" required maxlength="100">
                
                <!-- äºˆæ¸¬å¤‰æ›è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="title-suggestions" class="relative z-10 mb-3"></div>

                <textarea id="post-content" rows="4" placeholder="ã‚ãªãŸã®ç†±ã„æƒ³ã„ã‚’æ›¸ãè¾¼ã‚“ã§ãã ã•ã„ (2000æ–‡å­—ã¾ã§)" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary resize-none" required maxlength="2000"></textarea>
                <!-- ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é©ç”¨ -->
                <button type="submit" class="w-full bg-primary hover:bg-secondary text-white font-bold py-3 rounded-lg transition duration-150 shadow-md">
                    æŠ•ç¨¿ã™ã‚‹
                </button>
            </form>
        </section>

        <!-- æŠ•ç¨¿è¡¨ç¤ºæ¬„ -->
        <section>
            <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">ã¿ã‚“ãªã®æŠ•ç¨¿</h2>
            
            <!-- ã‚½ãƒ¼ãƒˆã¨æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°UIã®è¿½åŠ  -->
            <div class="mb-6 space-y-4">
                <div class="flex items-center space-x-3">
                    <label for="sort-criteria" class="text-gray-600 font-medium whitespace-nowrap">ã‚½ãƒ¼ãƒˆåŸºæº–:</label>
                    <select id="sort-criteria" onchange="sortAndRenderPosts()" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary bg-white text-gray-700">
                        <option value="latest">æœ€æ–°é †</option>
                        <option value="popular">äººæ°—é † (ã„ã„ã­é †)</option>
                    </select>
                </div>
                
                <div class="flex space-x-2">
                    <input type="text" id="filter-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" maxlength="100">
                    <button id="filter-button" onclick="handleFilter()" class="flex-shrink-0 bg-primary hover:bg-secondary text-white font-bold py-3 px-6 rounded-lg transition duration-150 shadow-md">
                        çµã‚Šè¾¼ã‚€
                    </button>
                </div>
            </div>

            <div id="posts-container" class="space-y-6">
                <!-- æŠ•ç¨¿ãŒã“ã“ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                <p id="loading-message" class="text-center text-gray-500">æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </section>
    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, addDoc, onSnapshot, serverTimestamp, doc, updateDoc, increment, setLogLevel, deleteDoc, arrayUnion, arrayRemove, getDoc, setDoc, where, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebaseè¨­å®šã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ç”¨
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // â˜…ä¿®æ­£: è¨­å®šãŒç©ºæ–‡å­—ã®å ´åˆã«JSON.parseã‚’è©¦ã¿ãªã„ã‚ˆã†ã«å®‰å…¨ãªãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : {};
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false; // èªè¨¼å®Œäº†ãƒ•ãƒ©ã‚°
        let allPosts = []; // ã™ã¹ã¦ã®æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹é…åˆ—
        let postIdToDelete = null; // å‰Šé™¤å¯¾è±¡ã®æŠ•ç¨¿IDã‚’ä¸€æ™‚çš„ã«ä¿æŒ
        let currentNickname = "åç„¡ã—OORer"; // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®åˆæœŸå€¤
        let userFilterId = null; // æŠ•ç¨¿çµã‚Šè¾¼ã¿ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
        let userPostCount = 0; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¨¿æ•°

        // ã‚¯ã‚¤ã‚ºçŠ¶æ…‹ç®¡ç†ç”¨å¤‰æ•°
        const QUIZ_COLLECTION_PATH = `/artifacts/${appId}/public/data/quiz_sessions`; 
        let currentQuizId = 'one_ok_rock_quiz'; // åˆæœŸãƒ«ãƒ¼ãƒ ID
        let quizListener = null; 
        let quizState = null; 
        const MAX_PLAYERS = 4;
        const MIN_PLAYERS_TO_START = 2;


        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹è¨­å®š
        const PUBLIC_COLLECTION_PATH = `/artifacts/${appId}/public/data/oneroom_board_posts`;
        const USERS_COLLECTION_PATH = `/artifacts/${appId}/public/data/users`; // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ä¿å­˜ç”¨

        // --- AIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆæ©Ÿèƒ½ ---
        
        const MIN_POSTS_FOR_AI = 3; // AIåˆ©ç”¨ã«å¿…è¦ãªæœ€ä½æŠ•ç¨¿æ•°
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";
        const apiKey = ""; 
        
        // Geminiã«è¦æ±‚ã™ã‚‹ã‚¯ã‚¤ã‚ºJSONã‚¹ã‚­ãƒ¼ãƒ
        const QUIZ_SCHEMA = {
            type: "OBJECT",
            properties: {
                "question": { "type": "STRING" },
                "options": {
                    "type": "ARRAY",
                    "description": "3ã¤ã®é¸æŠè‚¢",
                    "items": { "type": "STRING" }
                },
                "correctIndex": { 
                    "type": "NUMBER",
                    "description": "0, 1, 2ã®ã„ãšã‚Œã‹ã§æ­£è§£ã®é¸æŠè‚¢ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹"
                }, 
                "explanation": { "type": "STRING" }
            },
            propertyOrdering: ["question", "options", "correctIndex", "explanation"]
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            const chatForm = document.getElementById('ai-chat-form');
            if (chatForm) {
                chatForm.addEventListener('submit', handleAiChatSubmit);
            }
            // ãƒ«ãƒ¼ãƒ IDå…¥åŠ›æ¬„ã®åˆæœŸå€¤ã‚’è¨­å®š
            document.getElementById('room-id-input').value = currentQuizId;
        });
        
        // --- å…±é€šã®AIåˆ©ç”¨æ¡ä»¶ãƒã‚§ãƒƒã‚¯ ---
        function checkAICondition() {
            if (userPostCount < MIN_POSTS_FOR_AI) {
                showMessage(`AIæ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€æ²ç¤ºæ¿ã«ã‚ã¨${MIN_POSTS_FOR_AI - userPostCount}å›æŠ•ç¨¿ã—ã¦ãã ã•ã„ï¼`, true);
                return false;
            }
            return true;
        }

        // --- AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ ---

        async function handleAiChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('ai-chat-input');
            const query = input.value.trim();
            if (!query) return;

            if (!checkAICondition()) {
                input.value = '';
                return;
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            appendMessage(query, 'user');
            
            const loadingIndicator = document.getElementById('ai-loading-message');
            const chatButton = document.getElementById('ai-chat-button');
            
            input.value = '';
            chatButton.disabled = true;
            loadingIndicator.classList.remove('hidden');

            try {
                const responseText = await fetchGeminiResponse(query);
                appendMessage(responseText, 'ai');
            } catch (error) {
                console.error('Gemini APIã‚¨ãƒ©ãƒ¼:', error);
                appendMessage("ã”ã‚ã‚“ãªã•ã„ã€AIãŒå°‘ã—ç–²ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™...æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚", 'ai');
                showMessage("AIã¨ã®é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", true);
            } finally {
                chatButton.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        }
        
        // (appendMessage function goes here)
        function appendMessage(text, sender, sources = []) {
            const history = document.getElementById('ai-chat-history');
            const messageWrapper = document.createElement('div');
            
            if (sender === 'user') {
                messageWrapper.className = 'message-wrapper self-end';
                const userBubble = document.createElement('div');
                userBubble.className = 'message-bubble user-message';
                userBubble.textContent = text;
                messageWrapper.appendChild(userBubble);
            } else {
                messageWrapper.className = 'message-wrapper self-start';
                const aiBubble = document.createElement('div');
                aiBubble.className = 'message-bubble ai-message';
                aiBubble.textContent = text;
                messageWrapper.appendChild(aiBubble);

                if (sources.length > 0) {
                    const sourcesDiv = document.createElement('div');
                    sourcesDiv.className = 'text-xs text-gray-500 mt-1 ml-3 mb-2 max-w-[85%]';
                    sourcesDiv.innerHTML = '<strong>å‚ç…§å…ƒ:</strong> ' + sources.map(s => 
                        `<a href="${s.uri}" target="_blank" class="text-blue-500 hover:underline" title="${s.title}">${s.title}</a>`
                    ).join(', ');
                    messageWrapper.appendChild(sourcesDiv);
                }
            }
            
            history.appendChild(messageWrapper); 
            history.scrollTop = history.scrollHeight; 
        }
        
        // (fetchGeminiResponse function goes here)
        async function fetchGeminiResponse(query, retries = 0) {
            const systemPrompt = "ã‚ãªãŸã¯ONE OK ROCKã®å¤§ãƒ•ã‚¡ãƒ³ã§ã‚ã‚Šã€çŸ¥è­˜è±Šå¯Œãªãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«ç­”ãˆã€ãƒãƒ³ãƒ‰ã®æ­´å²ã€æ­Œè©ã€æ›²ã®è£è©±ã€ãƒ©ã‚¤ãƒ–æƒ…å ±ã«ã¤ã„ã¦ç†±æ„ã‚’æŒã£ã¦èªã‚Šã¾ã—ã‚‡ã†ã€‚å›ç­”ã¯æ—¥æœ¬èªã§ã€ç°¡æ½”ã‹ã¤æƒ…ç†±çš„ã«è¡Œã£ã¦ãã ã•ã„ã€‚";

            const payload = {
                contents: [{ parts: [{ text: query }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                    
                    return text + (sources.length > 0 ? "" : "\n\n(AIã®çŸ¥è­˜ã«åŸºã¥ãå›ç­”ã§ã™)");

                } else {
                    return "AIã¯å›ç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®è³ªå•ã‚’è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚";
                }

            } catch (error) {
                if (retries < 3) {
                    const delay = Math.pow(2, retries) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchGeminiResponse(query, retries + 1);
                }
                throw error;
            }
        }


        // --- ã‚¯ã‚¤ã‚ºæ©Ÿèƒ½ï¼ˆãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰ ---
        
        /**
         * AIã«ã‚¯ã‚¤ã‚ºå•é¡Œã‚’ç”Ÿæˆã•ã›ã‚‹ (JSONå½¢å¼)
         */
        async function generateQuizQuestion() {
            const prompt = "ONE OK ROCKã«é–¢ã™ã‚‹ã€ãƒãƒ‹ã‚¢ãƒƒã‚¯ã§é¢ç™½ã„ä¸‰æŠã‚¯ã‚¤ã‚ºã‚’ä¸€ã¤ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚å•é¡Œæ–‡ã€3ã¤ã®é¸æŠè‚¢ã€æ­£è§£ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0, 1, 2ã®ã„ãšã‚Œã‹ï¼‰ã€ãã®å•é¡Œã®èƒŒæ™¯ã‚’è§£èª¬ã™ã‚‹æ–‡ç« ã‚’JSONå½¢å¼ã§æä¾›ã—ã¦ãã ã•ã„ã€‚";
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "ã‚ãªãŸã¯ONE OK ROCKã«é–¢ã™ã‚‹ã‚¯ã‚¤ã‚ºã®ãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼ã§ã™ã€‚å¿…ãšè¦æ±‚ã•ã‚ŒãŸJSONã‚¹ã‚­ãƒ¼ãƒã«å¾“ã£ã¦å›ç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚" }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: QUIZ_SCHEMA,
                    tools: [{ "google_search": {} }]
                }
            };
            
            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                return JSON.parse(jsonText);
            } catch (error) {
                console.error("AIã‚¯ã‚¤ã‚ºç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
                throw new Error("AIãŒã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
            }
        }
        
        /**
         * ãƒ«ãƒ¼ãƒ IDã‚’å¤‰æ›´ã—ã€æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã«å‚åŠ ã™ã‚‹ (ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©)
         */
        window.changeQuizRoom = async function() {
            if (!isAuthReady) {
                showMessage("èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚", true);
                return;
            }
            if (!checkAICondition()) return;

            const input = document.getElementById('room-id-input');
            const newId = input.value.trim();

            if (!newId) {
                showMessage("ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true);
                return;
            }
            
            // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å‡º
            if (quizListener && currentQuizId) {
                await leaveQuizRoom(); 
                quizListener(); // å¤ã„ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
                quizListener = null;
            }

            // æ–°ã—ã„ãƒ«ãƒ¼ãƒ IDã‚’è¨­å®š
            currentQuizId = newId;
            // input.value = newId; // UIè¡¨ç¤ºã¯ãƒªã‚¹ãƒŠãƒ¼å†…ã§æ›´æ–°

            // ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ç›´ã—ã¦ã€æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã«å‚åŠ 
            setupQuizListener(); 

            showMessage(`ãƒ«ãƒ¼ãƒ IDã‚’ã€Œ${newId}ã€ã«åˆ‡ã‚Šæ›¿ãˆ/ä½œæˆã—ã¾ã—ãŸã€‚`, false);
        }

        /**
         * ã‚¯ã‚¤ã‚ºãƒ«ãƒ¼ãƒ ã«å‚åŠ ã™ã‚‹ (æœ€å¤§4äºº)
         */
        async function joinQuizRoom() {
            if (!isAuthReady) return;
            // ä¿®æ­£: quizIdã§ã¯ãªãcurrentQuizIdã‚’ä½¿ç”¨
            const quizRef = doc(db, QUIZ_COLLECTION_PATH, currentQuizId); 

            try {
                await runTransaction(db, async (transaction) => {
                    const quizDoc = await transaction.get(quizRef);
                    let currentQuiz = quizDoc.exists() ? quizDoc.data() : { status: 'lobby', players: {} };
                    
                    const players = currentQuiz.players || {};
                    const playerCount = Object.keys(players).length;

                    if (players[userId]) {
                        // æ—¢ã«ã„ã‚‹å ´åˆã€ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’æ›´æ–°
                        players[userId].name = currentNickname;
                    } else if (playerCount < MAX_PLAYERS) {
                        // åˆã‚ã¦å‚åŠ ã™ã‚‹å ´åˆ
                        players[userId] = { 
                            name: currentNickname, 
                            score: 0, 
                            joinedAt: serverTimestamp() 
                        };
                    } else {
                        // æº€å“¡ã®å ´åˆã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¸­æ–­
                        showMessage(`ãƒ«ãƒ¼ãƒ ã€Œ${currentQuizId}ã€ã¯æº€å“¡ã§ã™ (æœ€å¤§4å)ã€‚`, true);
                        return;
                    }

                    // ãƒ«ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’æ›´æ–°
                    transaction.set(quizRef, {
                        ...currentQuiz,
                        players: players,
                        status: currentQuiz.status === 'active' ? 'active' : 'lobby',
                        scores: currentQuiz.scores || {} // ã‚¹ã‚³ã‚¢ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯åˆæœŸåŒ–
                    }, { merge: true });
                });
            } catch (e) {
                console.error("ã‚¯ã‚¤ã‚ºãƒ«ãƒ¼ãƒ å‚åŠ ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤±æ•—:", e);
                // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤±æ•—æ™‚ã‚‚ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è¡¨ç¤ºã—ãªã„ (é »ç¹ã«èµ·ã“ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚)
            }
        }
        
        /**
         * ã‚¯ã‚¤ã‚ºãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å‡ºã™ã‚‹
         */
        async function leaveQuizRoom() {
            if (!isAuthReady) return;
            // ä¿®æ­£: quizIdã§ã¯ãªãcurrentQuizIdã‚’ä½¿ç”¨
            const quizRef = doc(db, QUIZ_COLLECTION_PATH, currentQuizId); 
            
            try {
                await runTransaction(db, async (transaction) => {
                    const quizDoc = await transaction.get(quizRef);
                    if (!quizDoc.exists()) return;

                    let currentQuiz = quizDoc.data();
                    let players = currentQuiz.players || {};

                    if (players[userId]) {
                        delete players[userId];
                    } else {
                        return;
                    }

                    // æœ€å¾Œã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé€€å‡ºã—ãŸå ´åˆã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¦ãƒªã‚»ãƒƒãƒˆ
                    if (Object.keys(players).length === 0) {
                        transaction.delete(quizRef);
                    } else {
                        transaction.update(quizRef, {
                            players: players,
                        });
                    }
                });
            } catch (e) {
                console.error("ã‚¯ã‚¤ã‚ºãƒ«ãƒ¼ãƒ é€€å‡ºãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤±æ•—:", e);
            }
        }
        
        // ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹å‰ã«é€€å‡ºå‡¦ç†ã‚’å®Ÿè¡Œ (ãƒ™ã‚¹ãƒˆã‚¨ãƒ•ã‚©ãƒ¼ãƒˆ)
        window.addEventListener('beforeunload', leaveQuizRoom);


        /**
         * æ–°ã—ã„ã‚¯ã‚¤ã‚ºã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ (2äººä»¥ä¸ŠãŒå¿…è¦)
         */
        window.startNewQuiz = async function() {
            if (!isAuthReady || !checkAICondition()) return;
            
            const controlButton = document.getElementById('start-quiz-button');
            const loading = document.getElementById('quiz-loading-message');
            
            controlButton.disabled = true;
            loading.classList.remove('hidden');

            try {
                const currentPlayers = quizState ? Object.keys(quizState.players).length : 0;
                if (currentPlayers < MIN_PLAYERS_TO_START) {
                    showMessage(`ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€${MIN_PLAYERS_TO_START}äººä»¥ä¸Šã®å‚åŠ è€…ãŒå¿…è¦ã§ã™ã€‚ç¾åœ¨${currentPlayers}äººã§ã™ã€‚`, true);
                    return; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°ãŒä¸è¶³
                }

                // 1. AIã«æœ€åˆã®å•é¡Œç”Ÿæˆã‚’è¦æ±‚
                const quizData = await generateQuizQuestion();
                
                // 2. Firestoreã‚’ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§åˆæœŸåŒ–
                // ä¿®æ­£: quizIdã§ã¯ãªãcurrentQuizIdã‚’ä½¿ç”¨
                const quizRef = doc(db, QUIZ_COLLECTION_PATH, currentQuizId); 
                
                await runTransaction(db, async (transaction) => {
                     const quizDoc = await transaction.get(quizRef);
                     let players = quizDoc.exists() ? quizDoc.data().players : {};
                     
                     // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¨å“¡ã®ã‚¹ã‚³ã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ
                     const initialScores = {};
                     for (const id in players) {
                         initialScores[id] = { name: players[id].name, score: 0 };
                     }

                     transaction.set(quizRef, {
                        status: 'active', // Game is now active
                        question: quizData.question,
                        options: quizData.options,
                        correctIndex: quizData.correctIndex,
                        explanation: quizData.explanation,
                        questionNumber: 1,
                        players: players, // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä¿æŒ
                        scores: initialScores, 
                        answeredBy: {}, 
                        correctAnswer: null,
                        answeredCount: 0,
                        timestamp: serverTimestamp()
                    });
                });
                
                showMessage("æ–°ã—ã„ã‚¯ã‚¤ã‚ºãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸï¼ ç¬¬1å•ã‚¹ã‚¿ãƒ¼ãƒˆï¼", false);
            } catch (error) {
                console.error("ã‚¯ã‚¤ã‚ºé–‹å§‹ã‚¨ãƒ©ãƒ¼:", error);
                showMessage(`ã‚¯ã‚¤ã‚ºã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, true);
            } finally {
                controlButton.disabled = false;
                loading.classList.add('hidden');
            }
        }

        /**
         * æ¬¡ã®å•é¡Œã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ï¼ˆèª°ã§ã‚‚å®Ÿè¡Œå¯èƒ½ã ãŒã€çŠ¶æ…‹ã¯FirestoreãŒç®¡ç†ï¼‰
         */
        window.requestNextQuestion = async function() {
            if (!isAuthReady || !checkAICondition() || quizState.status !== 'resolved') return; 
            
            const controlButton = document.getElementById('next-question-button');
            const loading = document.getElementById('quiz-loading-message');
            
            controlButton.disabled = true;
            loading.classList.remove('hidden');

            try {
                // 1. AIã«æ¬¡ã®å•é¡Œç”Ÿæˆã‚’è¦æ±‚
                const quizData = await generateQuizQuestion();
                
                // 2. Firestoreã‚’æ›´æ–°ï¼ˆæ¬¡ã®å•é¡Œã¸ï¼‰
                // ä¿®æ­£: quizIdã§ã¯ãªãcurrentQuizIdã‚’ä½¿ç”¨
                const quizRef = doc(db, QUIZ_COLLECTION_PATH, currentQuizId); 
                
                await updateDoc(quizRef, {
                    status: 'active',
                    question: quizData.question,
                    options: quizData.options,
                    correctIndex: quizData.correctIndex,
                    explanation: quizData.explanation,
                    questionNumber: quizState.questionNumber + 1,
                    // ã‚¹ã‚³ã‚¢ã¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã¯ç¶­æŒ
                    answeredBy: {}, 
                    correctAnswer: null,
                    answeredCount: 0,
                    timestamp: serverTimestamp()
                });
                
                showMessage(`ç¬¬${quizState.questionNumber + 1}å•ãŒã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã—ãŸï¼`, false);
            } catch (error) {
                console.error("æ¬¡ã®å•é¡Œã®ç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
                showMessage(`æ¬¡ã®å•é¡Œã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, true);
            } finally {
                controlButton.disabled = false;
                loading.classList.add('hidden');
            }
        }

        /**
         * ã‚¯ã‚¤ã‚ºã®å›ç­”å‡¦ç†ï¼ˆæœ€åˆã«æ­£è§£ã—ãŸäººã«ãƒã‚¤ãƒ³ãƒˆï¼‰
         */
        window.handleQuizAnswer = async function(answerIndex) {
            if (!isAuthReady || quizState.correctAnswer || quizState.status !== 'active') return;
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦å‚åŠ ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (!quizState.players || !quizState.players[userId]) {
                showMessage("ã‚¯ã‚¤ã‚ºã«å‚åŠ ã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒ«ãƒ¼ãƒ ã«å‚åŠ ã—ã¦ãã ã•ã„ã€‚", true);
                return;
            }

            // ä¿®æ­£: quizIdã§ã¯ãªãcurrentQuizIdã‚’ä½¿ç”¨
            const quizRef = doc(db, QUIZ_COLLECTION_PATH, currentQuizId); 

            try {
                await runTransaction(db, async (transaction) => {
                    const quizDoc = await transaction.get(quizRef);
                    if (!quizDoc.exists()) throw "Quiz not found";

                    const currentQuiz = quizDoc.data();

                    // æ—¢ã«å›ç­”æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
                    if (currentQuiz.answeredBy[userId] !== undefined) {
                        showMessage("ã‚ãªãŸã¯æ—¢ã«ã“ã®å•é¡Œã«å›ç­”æ¸ˆã¿ã§ã™ã€‚", true);
                        return;
                    }

                    const isCorrect = answerIndex === currentQuiz.correctIndex;
                    const newAnsweredBy = { ...currentQuiz.answeredBy, [userId]: answerIndex };
                    
                    let newScores = currentQuiz.scores || {};
                    let newCorrectAnswer = currentQuiz.correctAnswer;
                    let newStatus = currentQuiz.status;
                    
                    if (!newScores[userId]) {
                         newScores[userId] = { name: currentNickname, score: 0 };
                    }

                    if (isCorrect) {
                        if (currentQuiz.correctAnswer === null) {
                            // æœ€åˆã®æ­£è§£è€…ï¼
                            newCorrectAnswer = userId;
                            newScores[userId].score += 10;
                            newStatus = 'resolved'; 
                            
                            transaction.update(quizRef, {
                                answeredBy: newAnsweredBy,
                                scores: newScores,
                                correctAnswer: newCorrectAnswer,
                                status: newStatus,
                                answeredCount: (currentQuiz.answeredCount || 0) + 1,
                            });
                            showMessage("ğŸ‰ æ­£è§£ï¼æœ€åˆã«æ­£è§£ã—ã¾ã—ãŸï¼10ç‚¹ã‚²ãƒƒãƒˆï¼", false);
                        } else {
                            // æ­£è§£ã ãŒã€æ—¢ã«æ­£è§£è€…ãŒã„ã‚‹
                            transaction.update(quizRef, {
                                answeredBy: newAnsweredBy,
                                answeredCount: (currentQuiz.answeredCount || 0) + 1,
                            });
                            showMessage("æ­£è§£ï¼ã—ã‹ã—ã€æœ€åˆã«æ­£è§£ã—ãŸäººãŒã„ã¾ã—ãŸã€‚", false);
                        }
                    } else {
                        // ä¸æ­£è§£
                        transaction.update(quizRef, {
                            answeredBy: newAnsweredBy,
                            answeredCount: (currentQuiz.answeredCount || 0) + 1,
                        });
                        showMessage("æ®‹å¿µã€ä¸æ­£è§£ã§ã™...ã€‚", true);
                    }
                });
            } catch (e) {
                console.error("ã‚¯ã‚¤ã‚ºå›ç­”ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤±æ•—:", e);
                showMessage("ã‚¯ã‚¤ã‚ºã®å›ç­”å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", true);
            }
        }


        /**
         * ã‚¯ã‚¤ã‚ºçŠ¶æ…‹ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼è¨­å®š
         */
        function setupQuizListener() {
            if (quizListener) quizListener(); // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤

            // ä¿®æ­£: quizIdã§ã¯ãªãcurrentQuizIdã‚’ä½¿ç”¨
            const quizRef = doc(db, QUIZ_COLLECTION_PATH, currentQuizId);
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ«ãƒ¼ãƒ ã‚’é–‹ã„ãŸã¨ãã€è‡ªå‹•ã§å‚åŠ ã‚’è©¦ã¿ã‚‹
            if (isAuthReady) {
                joinQuizRoom(); 
            }

            quizListener = onSnapshot(quizRef, (doc) => {
                // UIã«ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ IDã‚’åæ˜ 
                document.getElementById('current-room-display').textContent = currentQuizId;
                document.getElementById('room-id-input').value = currentQuizId;

                if (doc.exists()) {
                    quizState = doc.data();
                    renderQuizUI(quizState);
                } else {
                    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆ (èª°ã‚‚ã„ãªã„å ´åˆã‚„å‰Šé™¤ã•ã‚ŒãŸå ´åˆ)
                    quizState = { status: 'lobby', players: {} };
                    renderQuizUI(quizState); 
                    // å‰Šé™¤ã•ã‚ŒãŸå ´åˆã€è‡ªå‹•ã§å†å‚åŠ ã‚’è©¦ã¿ã‚‹
                    if (isAuthReady) joinQuizRoom(); 
                }
            }, (error) => {
                console.error("ã‚¯ã‚¤ã‚ºãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:", error);
                quizState = { status: 'error', players: {} };
                renderQuizUI(quizState);
            });
        }
        
        /**
         * ã‚¯ã‚¤ã‚ºUIã®æç”»å‡¦ç†
         */
        function renderQuizUI(state) {
            const statusMessage = document.getElementById('quiz-status-message');
            const questionContainer = document.getElementById('quiz-question-container');
            const quizOptions = document.getElementById('quiz-options');
            const startButton = document.getElementById('start-quiz-button');
            const nextButton = document.getElementById('next-question-button');
            const currentQuestion = document.getElementById('current-question');
            const scoreboardList = document.getElementById('scoreboard-list');
            const playerSlots = document.getElementById('player-slots');
            const playerCountSpan = document.getElementById('player-count');

            // --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ãƒ­ãƒ“ãƒ¼ã®çŠ¶æ…‹ã‚’æ›´æ–° ---
            const players = state.players || {};
            const playerIds = Object.keys(players);
            const playerCount = playerIds.length;
            
            playerCountSpan.textContent = playerCount;
            playerSlots.innerHTML = '';
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ãƒ­ãƒƒãƒˆã®æç”»
            for (let i = 0; i < MAX_PLAYERS; i++) {
                const name = players[playerIds[i]] ? players[playerIds[i]].name : null;
                const playerDiv = document.createElement('div');
                playerDiv.className = 'flex items-center space-x-1 p-1 rounded-full text-xs font-semibold';
                
                if (name) {
                    // è‡ªåˆ†ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¯å¼·èª¿
                    const isMe = playerIds[i] === userId;
                    playerDiv.innerHTML = `<span class="bg-green-500 w-2 h-2 rounded-full"></span><span class="${isMe ? 'text-primary' : 'text-gray-700'}">${name}${isMe ? ' (ã‚ãªãŸ)' : ''}</span>`;
                } else {
                    playerDiv.innerHTML = `<span class="bg-gray-300 w-2 h-2 rounded-full"></span><span class="text-gray-500">ç©ºã(${i + 1}äººç›®)</span>`;
                }
                playerSlots.appendChild(playerDiv);
            }

            // --- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç®¡ç† ---

            if (state.status === 'lobby' || state.status === 'finished' || state.status === 'error' || !state.status) {
                // ãƒ­ãƒ“ãƒ¼çŠ¶æ…‹
                questionContainer.classList.add('hidden');
                startButton.classList.remove('hidden');
                nextButton.classList.add('hidden');
                
                if (playerCount < MIN_PLAYERS_TO_START) {
                    startButton.disabled = true;
                    statusMessage.textContent = `ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€ã‚ã¨${MIN_PLAYERS_TO_START - playerCount}äººãŒå¿…è¦ã§ã™ã€‚ï¼ˆæœ€å¤§${MAX_PLAYERS}äººï¼‰`;
                } else {
                    startButton.disabled = false;
                    statusMessage.textContent = `å‚åŠ è€…ï¼š${playerCount}äººã€‚ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã§ãã¾ã™ï¼`;
                }
                
                scoreboardList.innerHTML = '<p class="text-xs text-gray-400">ã‚¯ã‚¤ã‚ºé–‹å§‹å¾Œã«ã‚¹ã‚³ã‚¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>';
                if (state.status === 'finished') {
                    statusMessage.textContent = "ã‚²ãƒ¼ãƒ çµ‚äº†ï¼ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
                }
                return;
            }
            
            // --- ã‚¯ã‚¤ã‚ºã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ ---
            questionContainer.classList.remove('hidden');
            startButton.classList.add('hidden');

            currentQuestion.textContent = `Q${state.questionNumber}: ${state.question}`;
            quizOptions.innerHTML = '';
            
            const hasAnswered = state.answeredBy && state.answeredBy[userId] !== undefined;
            const isResolved = state.status === 'resolved';
            
            // --- é¸æŠè‚¢ã®æç”» ---
            state.options.forEach((option, index) => {
                const optionButton = document.createElement('button');
                optionButton.textContent = `${index + 1}. ${option}`;
                optionButton.className = `quiz-option w-full p-3 text-left rounded-lg transition duration-150 border font-medium whitespace-normal ${isResolved ? 'cursor-default' : 'cursor-pointer'}`;
                
                // å›ç­”æ¸ˆã¿ã€ã¾ãŸã¯è§£æ±ºæ¸ˆã¿ã€ã¾ãŸã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ãªã‘ã‚Œã°ç„¡åŠ¹åŒ–
                optionButton.disabled = hasAnswered || isResolved || !players[userId]; 
                
                optionButton.onclick = () => window.handleQuizAnswer(index);
                
                // --- çµæœè¡¨ç¤º ---
                if (isResolved) {
                    if (index === state.correctIndex) {
                        optionButton.className += ' bg-green-200 text-green-800 border-green-400';
                        optionButton.textContent += ' ğŸ‰æ­£è§£';
                    } else if (hasAnswered && index === state.answeredBy[userId]) {
                        optionButton.className += ' bg-red-200 text-red-800 border-red-400';
                        optionButton.textContent += ' âŒã‚ãªãŸã®å›ç­”';
                    } else {
                        optionButton.className += ' bg-white text-gray-700 border-gray-300';
                    }
                } else if (hasAnswered && index === state.answeredBy[userId]) {
                     // å›ç­”æ¸ˆã¿ã®é¸æŠè‚¢ï¼ˆè§£ç­”ä¸­ï¼‰
                    optionButton.className += ' bg-yellow-100 text-gray-700 border-yellow-300';
                } else {
                    optionButton.className += ' bg-white text-gray-700 border-gray-300';
                }
                
                quizOptions.appendChild(optionButton);
            });
            
            // --- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®æ›´æ–° ---
            if (isResolved) {
                const correctUserName = state.scores[state.correctAnswer] ? state.scores[state.correctAnswer].name : 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼';
                statusMessage.innerHTML = `âœ… **æ­£è§£ç™ºè¡¨ï¼** æ­£è§£ã¯**${state.correctIndex + 1}ç•ª**ã§ã—ãŸã€‚<br>æœ€åˆã«æ­£è§£ã—ãŸã®ã¯ **${correctUserName}** ã•ã‚“ï¼<br>
                                    <span class="text-sm mt-2 block">${state.explanation}</span>`;
                // æ¬¡ã®å•é¡Œã¸ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                nextButton.classList.remove('hidden');
            } else {
                statusMessage.textContent = `ç¬¬${state.questionNumber}å•ã«å›ç­”ã—ã¦ãã ã•ã„ï¼ (${state.answeredCount}äººå›ç­”æ¸ˆã¿)`;
                nextButton.classList.add('hidden');
            }
            
            // --- ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã®æ›´æ–° ---
            scoreboardList.innerHTML = '';
            
            const sortedScores = Object.values(state.scores || {}).sort((a, b) => b.score - a.score);
            
            if (sortedScores.length > 0) {
                sortedScores.forEach((player, index) => {
                    const scoreItem = document.createElement('p');
                    // 1ä½ã®è‰²ã‚’å¼·èª¿
                    const isTop = index === 0 && player.score > 0;
                    scoreItem.className = `font-bold p-1 rounded-md text-sm ${isTop ? 'text-primary' : 'text-gray-700'}`;
                    scoreItem.innerHTML = `${isTop ? 'ğŸ†' : ''} ${player.name}: <span class="text-primary">${player.score}ç‚¹</span>`;
                    scoreboardList.appendChild(scoreItem);
                });
            } else {
                scoreboardList.innerHTML = '<p class="text-xs text-gray-400">å‚åŠ è€…ãŒã„ã¾ã›ã‚“ã€‚</p>';
            }
        }


        // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ , æŠ•ç¨¿æ•°ï¼‰é–¢é€£ ---
        
        async function fetchNickname() {
            if (!userId) return;
            const userRef = doc(db, USERS_COLLECTION_PATH, userId);
            try {
                const userDoc = await getDoc(userRef);
                if (userDoc.exists() && userDoc.data().nickname) {
                    currentNickname = userDoc.data().nickname;
                }
            } catch (error) {
                console.error("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
            }
            updateUserInfoDisplay();
            // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ2: ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒç¢ºå®šã—ãŸã‚‰ã€ã‚¯ã‚¤ã‚ºãƒ«ãƒ¼ãƒ ã«å‚åŠ ã—ç›´ã™
            if (isAuthReady) {
                joinQuizRoom(); 
            }
        }

        async function saveNickname(e) {
            e.preventDefault();
            if (!isAuthReady) {
                showMessage("èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚", true);
                return;
            }
            
            const nicknameInput = document.getElementById('nickname-input');
            const newNickname = nicknameInput.value.trim();

            if (newNickname.length < 3) {
                showMessage("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¯3æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true);
                return;
            }

            try {
                const userRef = doc(db, USERS_COLLECTION_PATH, userId);
                await setDoc(userRef, { nickname: newNickname }, { merge: true });
                currentNickname = newNickname;
                updateUserInfoDisplay();
                hideNicknameModal();
                showMessage(`ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ã€Œ${newNickname}ã€ã«è¨­å®šã—ã¾ã—ãŸã€‚`, false);
                
                // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¤‰æ›´å¾Œã€ã‚¯ã‚¤ã‚ºãƒ«ãƒ¼ãƒ ã®å‚åŠ æƒ…å ±ã‚’æ›´æ–°
                joinQuizRoom(); 
            } catch (error) {
                console.error("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
                showMessage("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
            }
        }

        async function getUserPostCount() {
            if (!userId || !isAuthReady) {
                userPostCount = 0;
                return;
            }
            try {
                const postsColRef = collection(db, PUBLIC_COLLECTION_PATH);
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒä¸€è‡´ã™ã‚‹æŠ•ç¨¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const q = query(postsColRef, where("userId", "==", userId));
                
                // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°ã‚«ã‚¦ãƒ³ãƒˆ
                const snapshot = await getDocs(q);
                userPostCount = snapshot.size;
                
            } catch (error) {
                console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿æ•°å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                userPostCount = 0;
            }
            document.getElementById('user-post-count').textContent = userPostCount;
        }
        
        function updateUserInfoDisplay() {
            const userInfoElement = document.getElementById('user-info');
            userInfoElement.innerHTML = `ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ : <strong class="text-primary">${currentNickname}</strong>`;
            
            const nicknameInput = document.getElementById('nickname-input');
            if (nicknameInput) nicknameInput.value = currentNickname;
        }

        window.showNicknameModal = function() {
            document.getElementById('nickname-modal').classList.remove('hidden');
        }

        window.hideNicknameModal = function() {
            document.getElementById('nickname-modal').classList.add('hidden');
        }

        // --- ONE OK ROCK æ¥½æ›²ãƒªã‚¹ãƒˆ (äºˆæ¸¬å¤‰æ›ç”¨) ---
        const OOR_SONGS = [
            "Introduction", "å†…ç§˜å¿ƒæ›¸", "Borderline", "ï¼ˆYou can doï¼‰it!", "åŠªåŠª-ã‚†ã‚ã‚†ã‚-", "ã‚«ãƒ©ã‚¹", 
            "Crazy Bot", "ä¹±ç²Creature", "å¾Œæ‚”S.O.S.", "å¿…ç„¶ãƒ¡ãƒ¼ã‚«ãƒ¼", "One day", "å¤œã«ã—ã‹å’²ã‹ãªã„æº€æœˆ", 
            "çš†ç„¡", "20 years old", "Living dolls", "Break My Strings", "My sweet baby", "Reflection", 
            "around the world å°‘å¹´", "æ‹ãƒã‚¢ã‚¤ãƒœã‚¦å¿ƒãƒã‚¯ãƒ”ãƒ‰", "Viva la revolution", "Et cetera", 
            "Wherever you are", "Jibun ROCK", "Liar", "Pierce", "C.h.a.o.s.m.y.t.h.", 
            "Let's take it someday", "Kimikara-sensei", "ä¸–é–“çŸ¥ã‚‰ãšã®å®‡å®™é£›è¡Œå£«", "Mr.ç¾ä»£Speaker", 
            "æœªå®Œæˆäº¤éŸ¿æ›²", "Nobody's Home", "Kanzen Kankaku Dreamer", "Kagerou", "Deeper Deeper", 
            "Nothing Helps", "The Beginning", "Clock Strikes", "Be the light", "All Mine", 
            "Smiling down", "Decision", "Mighty Long Fall", "Heartache", "Suddenly", 
            "Stuck in the middle", "Good Goodbye", "One By One", "Paper Planes", "3xxxv5", 
            "Take me to the top", "Cry out", "The Way Back", "Memories", "Oh my god", 
            "Footsteps - In My Life -", "Ambitions - Introduction -", "Bombs Away", "Taking Off", 
            "We are", "20/20", "Always coming back", "Bedroom Warfare", "Lost in Tonight", 
            "I was King", "One Way Ticket", "Bon Voyage", "Start Again", "Eye of the Storm", 
            "Stand Out Fit In", "Head High", "Grow Old Die Young", "Push Back", "Wasted Nights", 
            "Change", "Let me let you go", "Worst in Me", "Giants", "Can't Wait", "The Last Time",
            "Save yourself", "Neon", "Vandalize", "When They All Fall Down", "Gravity", 
            "Mad World", "Free Them", "Renegades", "Broken Heart of Gold", "Wonder", "Prove",
            "Dive in the deep end", "Daydreaming", "Letting go", "So far gone"
        ];
        
        // --- æ—¥æ›¿ã‚ã‚Šãƒ†ãƒ¼ãƒå®šç¾© (JST 0:00ã§åˆ‡ã‚Šæ›¿ã‚ã‚‹) ---
        const OOR_THEMES = [
            { name: "Ambitions (èµ¤/æ¿ƒç´º)", primaryColor: "#FF5050", secondaryColor: "#1A2035", backgroundColor: "#F8F8F8" },
            { name: "Eye of the Storm (é’/é‡‘)", primaryColor: "#00AEEF", secondaryColor: "#FFD700", backgroundColor: "#F0F4F7" },
            { name: "35xxxv (ã‚°ãƒ¬ãƒ¼/ç´º)", primaryColor: "#797673", secondaryColor: "#2C3E50", backgroundColor: "#EAEAEA" },
            { name: "Luxury Disease (ç´«/æ©™)", primaryColor: "#8A2BE2", secondaryColor: "#FF4500", backgroundColor: "#FAFAFA" },
            { name: "Nicheã‚·ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ  (ãƒãƒ£ã‚³ãƒ¼ãƒ«/é‡‘)", primaryColor: "#36454F", secondaryColor: "#B8860B", backgroundColor: "#FFFFFF" }
        ];

        function applyDailyTheme() {
            // ç¾åœ¨ã®æ—¥æœ¬æ™‚é–“ (JST) ã‚’å–å¾—
            const now = new Date();
            // UTCæ™‚é–“ã‚’å–å¾—ã—ã€JST (+9æ™‚é–“) ã«å¤‰æ›
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const jstNow = new Date(utc + (3600000 * 9));
            
            // JSTã®æ—¥ä»˜ï¼ˆæ—¥ï¼‰ã«åŸºã¥ã„ã¦ãƒ†ãƒ¼ãƒã‚’æ±ºå®š
            const day = jstNow.getDate();
            const themeIndex = day % OOR_THEMES.length; // 5ã¤ã®ãƒ†ãƒ¼ãƒã‚’ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
            const theme = OOR_THEMES[themeIndex];

            const root = document.documentElement;
            // CSSã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ›´æ–°
            root.style.setProperty('--color-primary', theme.primaryColor);
            root.style.setProperty('--color-secondary', theme.secondaryColor);
            root.style.setProperty('--color-background', theme.backgroundColor);
            
            // bodyã®èƒŒæ™¯è‰²ã‚’å‹•çš„ã«è¨­å®š
            document.body.style.backgroundColor = theme.backgroundColor;

            showMessage(`ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒã¯ã€Œ${theme.name}ã€ã§ã™ï¼`, false);
        }

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

        function showMessage(text, isError = false) {
            const area = document.getElementById('message-area');
            const element = document.createElement('div');
            element.className = `p-3 mb-2 rounded-lg shadow-md text-white ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            element.textContent = text;
            area.appendChild(element);

            setTimeout(() => {
                element.remove();
            }, 3000);
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'æ—¥æ™‚ä¸æ˜';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            
            // JST (UTC+9) ã§è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«æ˜ç¤ºçš„ã«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’æŒ‡å®š
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false, // 24æ™‚é–“è¡¨ç¤º
                timeZone: 'Asia/Tokyo' // æ±äº¬æ™‚é–“ (JST) ã‚’æŒ‡å®š
            });
        }

        // --- åˆæœŸåŒ–ã¨èªè¨¼ ---

        async function initializeFirebase() {
            // ãƒ†ãƒ¼ãƒã‚’æœ€åˆã«é©ç”¨
            applyDailyTheme(); 
            
            try {
                // setLogLevel('debug');

                // â˜…ä¿®æ­£1: firebaseConfigãŒç©ºã®å ´åˆã¯åˆæœŸåŒ–ã—ãªã„
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebaseè¨­å®šãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // onAuthStateChangedãŒèªè¨¼çŠ¶æ…‹ã®å¤‰æ›´ã‚’å¾…ã¡ã€å‡¦ç†ã‚’è¡Œã†
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        const anonUser = await signInAnonymously(auth);
                        userId = anonUser.user.uid;
                    }

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        userId = auth.currentUser.uid;
                    }

                    isAuthReady = true; // èªè¨¼å®Œäº†
                    
                    // èªè¨¼å®Œäº†å¾Œã«ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ãƒ­ãƒ¼ãƒ‰ (ã‚¯ã‚¤ã‚ºãƒ«ãƒ¼ãƒ å‚åŠ ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã‚ˆã‚Šå‰ã«å®Ÿè¡Œ)
                    await fetchNickname();
                    
                    // æŠ•ç¨¿æ•°ã‚’æ›´æ–°
                    await getUserPostCount(); 
                    
                    if (localStorage.getItem('termsAgreed') === 'true') {
                        loadBoardDisplay(); 
                        loadBoardData(); // æ²ç¤ºæ¿ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ã‚‚èªè¨¼å®Œäº†å¾Œã«è¡Œã†
                    }
                });

            } catch (error) {
                console.error("Firebaseã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                showMessage(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, true);
            }
        }

        // --- åˆ©ç”¨è¦ç´„ã®å‡¦ç† ---

        window.agreeToTerms = function() {
            localStorage.setItem('termsAgreed', 'true');
            document.getElementById('terms-modal').classList.add('hidden');
            
            loadBoardDisplay(); 

            // ä¿®æ­£: isAuthReadyãŒtrueã«ãªã£ã¦ã„ã‚Œã°ã€ã“ã“ã§ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
            if (isAuthReady) {
                loadBoardData(); 
            } else {
                showMessage("èªè¨¼ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã¾ã§æŠ•ç¨¿ã®é–²è¦§ãƒ»æŠ•ç¨¿ã¯ã§ãã¾ã›ã‚“ã€‚", false);
            }
        }

        function checkTermsAgreement() {
            if (localStorage.getItem('termsAgreed') === 'true') {
                document.getElementById('terms-modal').classList.add('hidden');
            } else {
                document.getElementById('terms-modal').classList.remove('hidden');
            }
        }

        // --- ãƒ¡ã‚¤ãƒ³æ²ç¤ºæ¿ã®ãƒ­ãƒ¼ãƒ‰ ---
        
        function loadBoardDisplay() {
            document.getElementById('main-content').classList.remove('hidden');
            
            // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.getElementById('nickname-form').addEventListener('submit', saveNickname);
            
            setupPostForm();
            // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®ä¿å­˜ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.getElementById('edit-form').addEventListener('submit', savePostEdit);
            
            // --- å‰Šé™¤ç¢ºèªãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š ---
            document.getElementById('confirm-delete-button').addEventListener('click', confirmedDeletePost);

            // å›ºå®šãƒªãƒ³ã‚¯ã®è¡¨ç¤º
            renderFixedLiveLink(); 
        }

        function loadBoardData() {
            // èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ã€ã“ã“ã§å†ãƒã‚§ãƒƒã‚¯
            if (!isAuthReady) return; 
            setupPostListener();
            setupQuizListener();
        }


        // --- æŠ•ç¨¿å‡¦ç†ã¨äºˆæ¸¬å¤‰æ›æ©Ÿèƒ½ ---

        function setupPostForm() {
            const postTitleInput = document.getElementById('post-title');
            const suggestionsContainer = document.getElementById('title-suggestions');
            
            // --- äºˆæ¸¬å¤‰æ›æ©Ÿèƒ½ã®è¿½åŠ  ---
            
            postTitleInput.addEventListener('input', () => {
                showSuggestions(postTitleInput.value.trim(), postTitleInput, suggestionsContainer);
            });
            
            postTitleInput.addEventListener('blur', () => {
                setTimeout(() => {
                    suggestionsContainer.innerHTML = '';
                }, 200); 
            });


            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç† 
            document.getElementById('post-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!isAuthReady) {
                    showMessage("èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚", true);
                    return;
                }

                const title = document.getElementById('post-title').value.trim();
                const content = document.getElementById('post-content').value.trim();

                if (!title || !content) {
                    showMessage("ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‚’ä¸¡æ–¹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true);
                    return;
                }

                try {
                    await addDoc(collection(db, PUBLIC_COLLECTION_PATH), {
                        title: title,
                        content: content,
                        userId: userId,
                        userName: currentNickname, // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ä¿å­˜
                        timestamp: serverTimestamp(),
                        likes: 0,
                        likedBy: [], // ã„ã„ã­ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®é…åˆ—
                    });

                    showMessage("æŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
                    document.getElementById('post-form').reset();
                    
                    // æŠ•ç¨¿æˆåŠŸå¾Œã€æŠ•ç¨¿æ•°ã‚’æ›´æ–°
                    await getUserPostCount(); 
                } catch (error) {
                    console.error("æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:", error);
                    showMessage("æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
                }
            });
        }
        
        /**
         * äºˆæ¸¬å¤‰æ›ã‚’è¡¨ç¤ºã™ã‚‹
         */
        function showSuggestions(inputValue, inputElement, container) {
            container.innerHTML = '';
            if (inputValue.length === 0) {
                return;
            }

            const lowerInput = inputValue.toLowerCase();
            
            const filteredSongs = OOR_SONGS.filter(song => 
                song.toLowerCase().startsWith(lowerInput)
            ).slice(0, 8); // æœ€å¤§8ä»¶ã«é™å®š

            if (filteredSongs.length > 0) {
                const suggestionList = document.createElement('div');
                suggestionList.className = 'absolute w-full bg-white border border-gray-300 rounded-lg shadow-xl max-h-40 overflow-y-auto';
                
                filteredSongs.forEach(song => {
                    const item = document.createElement('div');
                    item.className = 'p-2 cursor-pointer text-gray-800 hover:bg-red-100 transition duration-100 truncate';
                    item.textContent = song;
                    
                    item.addEventListener('mousedown', (e) => { 
                        e.preventDefault();
                        inputElement.value = song;
                        container.innerHTML = ''; 
                        inputElement.focus(); 
                    });
                    
                    suggestionList.appendChild(item);
                });
                
                container.appendChild(suggestionList);
            }
        }


        // --- æŠ•ç¨¿ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°/ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ ---

        function setupPostListener() {
            // ä¿®æ­£: èªè¨¼ãƒã‚§ãƒƒã‚¯
            if (!isAuthReady) {
                console.warn("setupPostListener: èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚");
                return;
            }

            const loadingMessage = document.getElementById('loading-message'); 
            
            // Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã‚¯ã‚¨ãƒª (ã‚½ãƒ¼ãƒˆã¯è¡Œã‚ãªã„ã€æœ€æ–°é †ã§å–å¾—)
            const q = query(collection(db, PUBLIC_COLLECTION_PATH), orderBy('timestamp', 'desc'));

            // onSnapshotã§ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«å–å¾—ã—ã€allPostsã«ä¿å­˜ã™ã‚‹
            onSnapshot(q, (snapshot) => {
                
                if (loadingMessage) {
                    loadingMessage.classList.add('hidden');
                }

                if (snapshot.empty) {
                    allPosts = [];
                    renderPosts([]); // æŠ•ç¨¿ãŒãªã„å ´åˆã¯ç©ºã®ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                    return;
                }

                // 1. å–å¾—ã—ãŸã™ã¹ã¦ã®æŠ•ç¨¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
                allPosts = [];
                snapshot.forEach(doc => {
                    allPosts.push({ id: doc.id, ...doc.data() });
                });
                
                // 2. ç¾åœ¨ã®ã‚½ãƒ¼ãƒˆã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®çŠ¶æ…‹ã‚’ç¶­æŒã—ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                window.sortAndRenderPosts(); 

            }, (error) => {
                console.error("æŠ•ç¨¿ã®å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                
                if (loadingMessage) {
                    loadingMessage.classList.add('hidden');
                }
                document.getElementById('posts-container').innerHTML = `<p class="text-center text-red-500 p-8">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</p>`;
            });
        }
        
        /**
         * ç¾åœ¨ã®ã‚½ãƒ¼ãƒˆåŸºæº–ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«åŸºã¥ã„ã¦æŠ•ç¨¿ã‚’ã‚½ãƒ¼ãƒˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
         * (ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©)
         */
        window.sortAndRenderPosts = function() {
            let postsToRender = [...allPosts]; // allPostsã®ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ
            const sortCriteria = document.getElementById('sort-criteria').value;
            const filterInput = document.getElementById('filter-input');
            const filterTerm = filterInput ? filterInput.value.trim().toLowerCase() : null;

            // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° (æœ€å„ªå…ˆ) ---
            const clearFilterButton = document.getElementById('clear-user-filter-button');
            if (userFilterId) {
                postsToRender = postsToRender.filter(post => post.userId === userFilterId);
                clearFilterButton.classList.remove('hidden');
            } else {
                 clearFilterButton.classList.add('hidden');
            }

            // --- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° ---
            if (filterTerm) {
                postsToRender = postsToRender.filter(post => 
                    post.title.toLowerCase().includes(filterTerm)
                );
            }

            // --- ã‚½ãƒ¼ãƒˆã®é©ç”¨ ---
            if (sortCriteria === 'popular') {
                // ã„ã„ã­ã®æ•°ï¼ˆlikesï¼‰ãŒå¤šã„é †ã«ã‚½ãƒ¼ãƒˆ
                postsToRender.sort((a, b) => (b.likes || 0) - (a.likes || 0));
            } else { // 'latest'
                // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
                postsToRender.sort((a, b) => {
                    const timeA = a.timestamp && a.timestamp.toMillis ? a.timestamp.toMillis() : 0;
                    const timeB = b.timestamp && b.timestamp.toMillis ? b.timestamp.toMillis() : 0;
                    return timeB - timeA;
                });
            }
            
            // æç”»
            renderPosts(postsToRender);
        }
        
        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã«ã‚ˆã‚‹æŠ•ç¨¿çµã‚Šè¾¼ã¿ã‚’å®Ÿè¡Œã™ã‚‹ (ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©)
         * @param {string} id - çµã‚Šè¾¼ã‚€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ID
         * @param {string} name - çµã‚Šè¾¼ã‚€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ 
         */
        window.filterByUser = function(id, name) {
            userFilterId = id;
            window.sortAndRenderPosts();
            // ä¿®æ­£: IDã§ã¯ãªããƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’è¡¨ç¤º
            showMessage(`${name}ã•ã‚“ã®æŠ•ç¨¿ã«çµã‚Šè¾¼ã¿ã¾ã—ãŸã€‚`, false);
        }
        
        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿ã‚’è§£é™¤ã™ã‚‹ (ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©)
         */
        window.clearUserFilter = function() {
            userFilterId = null;
            document.getElementById('filter-input').value = ''; // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã‚‚ã‚¯ãƒªã‚¢
            window.sortAndRenderPosts();
            showMessage("ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿ä¸€è¦§ã®çµã‚Šè¾¼ã¿ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚", false);
        }
        
        /**
         * ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç†ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©ï¼‰
         */
        window.handleFilter = function() {
            userFilterId = null; // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢æ™‚ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒ•ã‚£ãƒ«ã‚¿ã‚’è§£é™¤
            window.sortAndRenderPosts();
            
            const filterTerm = document.getElementById('filter-input').value.trim().toLowerCase();
            if (filterTerm) {
                showMessage(`ã€Œ${filterTerm}ã€ã‚’å«ã‚€æŠ•ç¨¿ã‚’çµã‚Šè¾¼ã¿ã¾ã—ãŸã€‚`, false);
            } else {
                showMessage(`çµã‚Šè¾¼ã¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚`, false);
            }
        }

        /**
         * æŠ•ç¨¿é…åˆ—ã‚’å…ƒã«DOMã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
         * @param {Array} postsToRender è¡¨ç¤ºã™ã‚‹æŠ•ç¨¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
         */
        function renderPosts(postsToRender) {
            const postsContainer = document.getElementById('posts-container');
            postsContainer.innerHTML = ''; // ä¸€åº¦ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢

            if (postsToRender.length === 0) {
                postsContainer.innerHTML = '<p class="text-center text-gray-500 p-8">è©²å½“ã™ã‚‹æŠ•ç¨¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
                return;
            }

            postsToRender.forEach(post => {
                const postElement = createPostElement(post.id, post);
                postsContainer.appendChild(postElement);
                // ã‚³ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å†è¨­å®š (postIdã¯post.idã«å«ã¾ã‚Œã¦ã„ã‚‹)
                setupCommentListener(post.id);
            });
        }

        // æŠ•ç¨¿è¦ç´ ã®DOMæ§‹ç¯‰
        function createPostElement(postId, post) {
            const postDiv = document.createElement('div');
            postDiv.id = `post-${postId}`;
            postDiv.className = 'bg-white p-6 rounded-xl shadow-lg border border-gray-200';
            
            const isLiked = post.likedBy && post.likedBy.includes(userId);
            const isAuthor = post.userId === userId; // è‘—è€…ãƒã‚§ãƒƒã‚¯
            
            // ã„ã„ã­ãƒœã‚¿ãƒ³ã®è‰²ã‚‚ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«åˆã‚ã›ã‚‹
            const likeButtonColor = isLiked ? 'text-primary' : 'text-gray-400';
            const likeButtonFill = isLiked ? 'fill-current' : 'fill-none';
            
            // è‘—è€…ç”¨ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
            const authorActionsHTML = isAuthor ? `
                <div class="flex space-x-2 mt-3 justify-end">
                    <button onclick="showEditModal('${postId}')" class="text-xs text-blue-500 hover:text-blue-700 font-medium py-1 px-2 rounded-lg transition duration-150 border border-blue-200">
                        ç·¨é›†
                    </button>
                    <button onclick="deletePost('${postId}')" class="text-xs text-red-500 hover:text-red-700 font-medium py-1 px-2 rounded-lg transition duration-150 border border-red-200">
                        å‰Šé™¤
                    </button>
                </div>
            ` : '';
            
            const postUserName = post.userName || "åç„¡ã—OORer"; // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®åˆ©ç”¨

            postDiv.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-xl font-bold text-gray-800 break-words">${post.title}</h3>
                    <button class="like-button flex items-center p-2 rounded-full hover:bg-red-50 transition duration-150" data-post-id="${postId}" onclick="toggleLike('${postId}', ${isLiked})">
                        <svg class="w-6 h-6 ${likeButtonColor} ${likeButtonFill}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        <span id="like-count-${postId}" class="ml-1 text-sm font-semibold text-gray-600">${post.likes || 0}</span>
                    </button>
                </div>
                <p class="text-gray-700 mb-4 whitespace-pre-wrap break-words">${post.content}</p>
                
                ${authorActionsHTML} <!-- ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’æŒ¿å…¥ -->

                <div class="text-xs text-gray-500 border-t pt-2 mt-4 flex justify-between items-center">
                    <!-- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã§çµã‚Šè¾¼ã¿ -->
                    <span class="cursor-pointer hover:underline text-gray-600 font-medium" onclick="filterByUser('${post.userId}', '${postUserName}')">
                        æŠ•ç¨¿è€…: ${postUserName}
                    </span>
                    <span>æŠ•ç¨¿æ—¥æ™‚: ${formatTimestamp(post.timestamp)}</span>
                </div>

                <!-- ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="mt-5 border-t pt-4">
                    <h4 class="text-md font-semibold mb-3 text-gray-700">ã‚³ãƒ¡ãƒ³ãƒˆ (<span id="comment-count-${postId}">0</span>ä»¶)</h4>
                    <div id="comments-list-${postId}" class="space-y-3 mb-4">
                        <!-- ã‚³ãƒ¡ãƒ³ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                    
                    <!-- ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
                    <form class="comment-form flex" data-post-id="${postId}" data-parent-id="">
                        <input type="text" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..." class="comment-input w-full p-2 border border-gray-300 rounded-l-lg text-sm focus:ring-primary focus:border-primary" required maxlength="500">
                        <!-- ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é©ç”¨ -->
                        <button type="submit" class="bg-primary hover:bg-secondary text-white text-sm font-bold px-4 py-2 rounded-r-lg transition duration-150">
                            é€ä¿¡
                        </button>
                    </form>
                </div>
            `;
            
            // ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            postDiv.querySelector('.comment-form').addEventListener('submit', handleCommentSubmit);

            return postDiv;
        }

        // --- å›ºå®šãƒ©ã‚¤ãƒ–æƒ…å ±ãƒªãƒ³ã‚¯ã®è¡¨ç¤ºï¼ˆæ¤œç´¢ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ãªã„ï¼‰ ---

        function renderFixedLiveLink() {
            const container = document.getElementById('live-info-container');
            
            // ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ã—ã¦ãƒªã‚¹ãƒˆã‚’è¦‹ã‚„ã™ãã™ã‚‹
            container.classList.remove('p-6');
            container.classList.add('p-0'); 
            
            const officialSiteUrl = 'https://www.oneokrock.com/jp/';

            container.innerHTML = `
                <ul class="divide-y divide-gray-100">
                    <li class="p-4 bg-primary text-white hover:bg-secondary transition duration-100 font-bold">
                        <a href="${officialSiteUrl}" target="_blank" class="block">
                            <p class="text-base">ONE OK ROCK å…¬å¼ã‚µã‚¤ãƒˆï¼ˆ${officialSiteUrl.replace('https://', '').replace('/jp/', '')}ï¼‰</p>
                            <p class="text-sm opacity-90 mt-1">æœ€æ–°ã®ãƒ©ã‚¤ãƒ–ãƒ»ãƒã‚±ãƒƒãƒˆæƒ…å ±ã¯å…¬å¼ã‚µã‚¤ãƒˆã§å¿…ãšã”ç¢ºèªãã ã•ã„ã€‚</p>
                        </a>
                    </li>
                </ul>
            `;
        }

        // --- æŠ•ç¨¿ã®ç·¨é›†ãƒ»å‰Šé™¤æ©Ÿèƒ½ ---
        
        /**
         * å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
         */
        window.showDeleteConfirmModal = function(postId) {
            postIdToDelete = postId;
            document.getElementById('delete-confirm-modal').classList.remove('hidden');
        }

        /**
         * å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
         */
        window.hideDeleteConfirmModal = function() {
            postIdToDelete = null;
            document.getElementById('delete-confirm-modal').classList.add('hidden');
        }
        
        /**
         * æŠ•ç¨¿ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å‰Šé™¤ã™ã‚‹ï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«çµŒç”±ï¼‰
         */
        window.deletePost = function(postId) { 
            if (!isAuthReady) {
                showMessage("èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚", true);
                return;
            }
            window.showDeleteConfirmModal(postId); // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        }
        
        /**
         * å‰Šé™¤ã®ç¢ºå®šå‡¦ç†
         */
        async function confirmedDeletePost() {
            if (!postIdToDelete || !isAuthReady) {
                showMessage("å‰Šé™¤ã™ã‚‹æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", true);
                window.hideDeleteConfirmModal();
                return;
            }

            const postRef = doc(db, PUBLIC_COLLECTION_PATH, postIdToDelete);
            try {
                // è¦ªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
                await deleteDoc(postRef);
                showMessage("æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
                
                // æŠ•ç¨¿å‰Šé™¤å¾Œã€æŠ•ç¨¿æ•°ã‚’æ›´æ–°
                await getUserPostCount(); 
            } catch (error) {
                console.error("æŠ•ç¨¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
                showMessage("æŠ•ç¨¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
            } finally {
                window.hideDeleteConfirmModal(); // å‡¦ç†å¾Œã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éš ã™
            }
        }

        /**
         * ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
         */
        window.showEditModal = function(postId) {
            const post = allPosts.find(p => p.id === postId);
            if (!post) {
                showMessage("ç·¨é›†ã™ã‚‹æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚", true);
                return;
            }
            
            // èªè¨¼ã•ã‚Œã¦ã„ãªã„ã‹ã€æŠ•ç¨¿è€…ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
            if (!isAuthReady || post.userId !== userId) {
                 showMessage("ã“ã®æŠ•ç¨¿ã‚’ç·¨é›†ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", true);
                 return;
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
            document.getElementById('edit-post-id').value = postId;
            document.getElementById('edit-title').value = post.title;
            document.getElementById('edit-content').value = post.content;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        /**
         * ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
         */
        window.hideEditModal = function() {
            document.getElementById('edit-modal').classList.add('hidden');
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('edit-form').reset();
        }

        /**
         * ç·¨é›†ã—ãŸæŠ•ç¨¿å†…å®¹ã‚’ä¿å­˜ã™ã‚‹
         */
        async function savePostEdit(e) {
            e.preventDefault();
            if (!isAuthReady) {
                showMessage("èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚", true);
                return;
            }

            const postId = document.getElementById('edit-post-id').value;
            const newTitle = document.getElementById('edit-title').value.trim();
            const newContent = document.getElementById('edit-content').value.trim();
            
            if (!newTitle || !newContent) {
                showMessage("ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‚’ä¸¡æ–¹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true);
                return;
            }

            const postRef = doc(db, PUBLIC_COLLECTION_PATH, postId);
            
            try {
                await updateDoc(postRef, {
                    title: newTitle,
                    content: newContent,
                    editedAt: serverTimestamp() 
                });

                showMessage("æŠ•ç¨¿ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
                window.hideEditModal();
            } catch (error) {
                console.error("æŠ•ç¨¿ç·¨é›†ã‚¨ãƒ©ãƒ¼:", error);
                showMessage("æŠ•ç¨¿ã®ç·¨é›†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
            }
        }

        // --- ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã„ã„ã­ï¼‰æ©Ÿèƒ½ ---

        window.toggleLike = async function(postId, currentlyLiked) {
            if (!isAuthReady) {
                showMessage("èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚", true);
                return;
            }
            
            const postRef = doc(db, PUBLIC_COLLECTION_PATH, postId);
            
            try {
                // Firestoreå´ã§likedByé…åˆ—ã®æ›´æ–°
                if (currentlyLiked) {
                    // ã„ã„ã­ã‚’è§£é™¤ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
                    await updateDoc(postRef, {
                        likes: increment(-1),
                        likedBy: arrayRemove(userId) // â˜…ä¿®æ­£: arrayRemoveã§ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å‰Šé™¤
                    });
                    showMessage("ãƒãƒ¼ãƒˆã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚", false); 
                } else {
                    // ã„ã„ã­ã‚’è¿½åŠ ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
                    await updateDoc(postRef, {
                        likes: increment(1),
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’é…åˆ—ã«è¿½åŠ 
                        likedBy: arrayUnion(userId)
                    });
                    showMessage("ãƒãƒ¼ãƒˆã‚’è´ˆã‚Šã¾ã—ãŸï¼");
                }
            } catch (error) {
                console.error("ã„ã„ã­ã‚¨ãƒ©ãƒ¼:", error);
                showMessage("ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
            }
        }

        // --- ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ ---

        function handleCommentSubmit(e) {
            e.preventDefault();
            if (!isAuthReady) {
                showMessage("èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚", true);
                return;
            }

            const form = e.target;
            const postId = form.getAttribute('data-post-id');
            const parentId = form.getAttribute('data-parent-id') || null; // è¦ªã‚³ãƒ¡ãƒ³ãƒˆID
            const input = form.querySelector('.comment-input');
            const commentText = input.value.trim();

            if (!commentText) return;

            try {
                const commentsCollectionRef = collection(db, PUBLIC_COLLECTION_PATH, postId, 'comments');
                addDoc(commentsCollectionRef, {
                    text: commentText,
                    userId: userId,
                    userName: currentNickname, // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ä¿å­˜
                    parentId: parentId, // è¦ªã‚³ãƒ¡ãƒ³ãƒˆIDã‚’ä¿å­˜
                    timestamp: serverTimestamp()
                });
                
                // ã‚³ãƒ¡ãƒ³ãƒˆé€ä¿¡å¾Œã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€è¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã‚’éš ã™
                input.value = '';
                if (parentId) {
                    const replyFormContainer = document.getElementById(`reply-form-container-${parentId}`);
                    if (replyFormContainer) replyFormContainer.innerHTML = ''; 
                }
                showMessage("ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸã€‚");
            } catch (error) {
                console.error("ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:", error);
                showMessage("ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
            }
        }
        
        /**
         * ã‚³ãƒ¡ãƒ³ãƒˆè¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ (ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©)
         */
        window.toggleReplyForm = function(postId, parentId, parentAuthorName) {
            const containerId = `reply-form-container-${parentId}`;
            const container = document.getElementById(containerId);

            if (!container) return;
            
            // æ—¢ã«ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯éè¡¨ç¤ºã«ã™ã‚‹
            if (container.innerHTML !== '') {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <form class="comment-form flex mt-2 ml-4 md:ml-6" data-post-id="${postId}" data-parent-id="${parentId}">
                    <input type="text" placeholder="${parentAuthorName}ã•ã‚“ã¸è¿”ä¿¡..." class="comment-input w-full p-2 border border-gray-300 rounded-l-lg text-sm focus:ring-primary focus:border-primary" required maxlength="500">
                    <button type="submit" class="bg-primary hover:bg-secondary text-white text-sm font-bold px-4 py-2 rounded-r-lg transition duration-150">
                        è¿”ä¿¡
                    </button>
                </form>
            `;
            
            // æ–°ã—ãä½œæˆã—ãŸãƒ•ã‚©ãƒ¼ãƒ ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            container.querySelector('.comment-form').addEventListener('submit', handleCommentSubmit);
            container.querySelector('.comment-input').focus();
        }

        function setupCommentListener(postId) {
            const commentsList = document.getElementById(`comments-list-${postId}`);
            const commentCountSpan = document.getElementById(`comment-count-${postId}`);
            if (!commentsList) return;

            const commentsQuery = query(collection(db, PUBLIC_COLLECTION_PATH, postId, 'comments'), orderBy('timestamp', 'asc'));

            onSnapshot(commentsQuery, (snapshot) => {
                
                const commentsData = [];
                snapshot.forEach(doc => {
                    commentsData.push({ id: doc.id, ...doc.data() });
                });

                commentCountSpan.textContent = commentsData.length;
                
                // ã‚³ãƒ¡ãƒ³ãƒˆã‚’éšå±¤åŒ–
                const topLevelComments = commentsData.filter(c => !c.parentId);
                const nestedComments = {};
                commentsData.forEach(c => {
                    if (c.parentId) {
                        if (!nestedComments[c.parentId]) {
                            nestedComments[c.parentId] = [];
                        }
                        nestedComments[c.parentId].push(c);
                    }
                });
                
                commentsList.innerHTML = '';

                // ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã‚³ãƒ¡ãƒ³ãƒˆã¨è¿”ä¿¡ã‚’æç”»
                topLevelComments.forEach(comment => {
                    const commentElement = createCommentElement(comment, postId);
                    commentsList.appendChild(commentElement);
                    
                    const replies = nestedComments[comment.id] || [];
                    replies.forEach(reply => {
                        const replyElement = createCommentElement(reply, postId, true); // trueã§ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ
                        commentsList.appendChild(replyElement);
                    });
                });

            }, (error) => {
                console.error(`ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼ (Post ID: ${postId}):`, error);
                commentsList.innerHTML = `<p class="text-xs text-red-400">ã‚³ãƒ¡ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã€‚</p>`;
            });
        }

        // ã‚³ãƒ¡ãƒ³ãƒˆè¦ç´ ã®DOMæ§‹ç¯‰
        function createCommentElement(comment, postId, isReply = false) {
            const commentDiv = document.createElement('div');
            const commentUserName = comment.userName || "åç„¡ã—OORer";
            const commentId = comment.id;
            
            // è¿”ä¿¡ã‚³ãƒ¡ãƒ³ãƒˆã®å ´åˆã¯ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’é©ç”¨
            commentDiv.className = `p-3 rounded-lg border border-gray-200 ${isReply ? 'ml-4 md:ml-8 bg-gray-100' : 'bg-gray-50'}`;
            
            commentDiv.innerHTML = `
                <p class="text-sm text-gray-800 break-words">${comment.text}</p>
                <div class="text-xs text-gray-500 mt-1 flex justify-between items-center">
                    <!-- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã§çµã‚Šè¾¼ã¿ -->
                    <span class="cursor-pointer hover:underline text-gray-600 font-medium" onclick="filterByUser('${comment.userId}', '${commentUserName}')">
                        ${commentUserName}
                    </span>
                    <div class="flex items-center space-x-2">
                         <span>${formatTimestamp(comment.timestamp)}</span>
                         <!-- è¿”ä¿¡ãƒœã‚¿ãƒ³ (ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«/å­ã‚³ãƒ¡ãƒ³ãƒˆä¸¡æ–¹ã«ã¤ã‘ã‚‹) -->
                         <button onclick="toggleReplyForm('${postId}', '${commentId}', '${commentUserName}')" 
                                 class="text-blue-500 hover:text-blue-700 font-semibold transition duration-150 ml-2">
                             è¿”ä¿¡
                         </button>
                    </div>
                </div>
                <!-- è¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠ (ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã«å¯¾ã™ã‚‹è¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹) -->
                <div id="reply-form-container-${commentId}"></div>
            `;
            return commentDiv;
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
        window.onload = initializeFirebase;
        checkTermsAgreement();

    </script>
</body>
</html>
